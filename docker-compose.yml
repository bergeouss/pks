services:
  qdrant:
    image: qdrant/qdrant:v1.12.0
    container_name: pks-qdrant
    ports:
      - "7333:6333"
      - "7334:6334"
    volumes:
      - ./data/qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__LOG_LEVEL=INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 5s bash -c ':> /dev/tcp/127.0.0.1/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: pks-backend
    ports:
      - "8100:8000"
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ZAI_API_KEY=${ZAI_API_KEY}
      - ZAI_BASE_URL=${ZAI_BASE_URL:-https://open.bigmodel.cn/api/paas/v4}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DEFAULT_LLM_PROVIDER=${DEFAULT_LLM_PROVIDER:-zai}
      - DEFAULT_EMBEDDING_PROVIDER=${DEFAULT_EMBEDDING_PROVIDER:-gemini}
      - DEFAULT_EMBEDDING_MODEL=${DEFAULT_EMBEDDING_MODEL:-text-embedding-3-small}
    volumes:
      - ./data:/app/data
      - ./backend/app:/app/app
    depends_on:
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: pks-frontend
    ports:
      - "3100:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8100
    depends_on:
      - backend
    restart: unless-stopped

  file-watcher:
    build:
      context: ./file-watcher
      dockerfile: Dockerfile
    container_name: pks-file-watcher
    volumes:
      - ./data/inbox:/app/inbox
      - ./data/processed:/app/processed
    environment:
      - BACKEND_URL=http://backend:8000
      - WATCH_PATH=/app/inbox
    depends_on:
      - backend
    restart: unless-stopped
